<%- include('partials/header', { title: title }) %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Admin Dashboard</h3>
    <div>
      <span class="mr-3">Đăng nhập: <strong><%= adminUser %></strong></span>
      <a href="/admin/logout" class="btn btn-outline-secondary btn-sm">Logout</a>
    </div>
  </div>

  <% if (message) { %>
    <div class="alert alert-info"><%= message %></div>
  <% } %>

  <div class="row">

    <!-- LEFT SIDE -->
    <div class="col-md-5">

      <!-- UPLOAD LESSON -->
      <div class="card mb-3">
        <div class="card-body">
          <h5>Thêm bài học mới</h5>
          <form method="post" action="/admin/upload-lesson" enctype="multipart/form-data">
            <div class="form-group">
              <label>Chủ đề</label>
              <select name="book_id" class="form-control">
                <option value="">-------</option>
                <% books.forEach(b => { %>
                  <option value="<%= b.id %>"><%= b.title %></option>
                <% }) %>
              </select>
            </div>

            <div class="form-group">
              <label>Tiêu đề</label>
              <input name="title" class="form-control" required>
            </div>

            <div class="form-group">
              <label>Mục tiêu cần đạt</label>
              <textarea id="editorObjectives" name="objectives" class="form-control" rows="2"></textarea>
            </div>

            <div class="form-group">
              <label>Nội dung</label>
              <textarea id="editor" name="content" class="form-control" rows="6"></textarea>
            </div>

            <div class="form-group">
              <label>File đính kèm (pdf/docx/...)</label>
              <input type="file" name="attachment" class="form-control-file">
            </div>

            <button class="btn btn-success">Upload</button>
          </form>
        </div>
      </div>


      <!-- PRODUCT GROUP MANAGEMENT -->
      <div class="card mb-3">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Quản lý nhóm sản phẩm</h5>
            <a class="btn btn-sm btn-success" href="/admin/product-group/new">Tạo nhóm mới</a>
          </div>

          <% if (productGroups && productGroups.length) { %>
            <table class="table table-sm mt-2">
              <thead>
                <tr><th>Tên nhóm</th><th>Vị trí</th><th></th></tr>
              </thead>
              <tbody>
                <% productGroups.forEach(g => { %>
                  <tr>
                    <td>
                      <% if (g.cover) { %>
                        <img src="<%= g.cover %>" style="height:36px;margin-right:8px;vertical-align:middle;">
                      <% } %>
                      <strong><%= g.name %></strong><br>
                      <small class="text-muted"><%= g.slug %></small>
                    </td>
                    <td><%= g.position %></td>
                    <td style="white-space:nowrap">
                      <a href="/admin/product-group/edit/<%= g.id %>" class="btn btn-sm btn-outline-secondary">Sửa</a>

                      <form method="post" action="/admin/product-group/delete"
                            style="display:inline-block"
                            onsubmit="return confirm('Xóa nhóm và toàn bộ sản phẩm?');">
                        <input type="hidden" name="id" value="<%= g.id %>">
                        <button class="btn btn-sm btn-danger">Xóa</button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="text-muted mt-2">Chưa có nhóm sản phẩm.</div>
          <% } %>

        </div>
      </div>
            <!-- PRODUCT LIST MANAGEMENT -->
      <div class="card mb-3">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Quản lý sản phẩm</h5>
            <a class="btn btn-sm btn-success" href="/admin/product/new">Tạo sản phẩm mới</a>
          </div>

          <% if (productsList && productsList.length) { %>
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Tên</th>
                  <th>Nhóm</th>
                  <th>Giá</th>
                  <th>SKU</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <% productsList.forEach(p => { %>
                  <tr>
                    <td><%= p.title %></td>
                    <td><%= p.group_name || '-' %></td>
                    <td><%= Number(p.price).toLocaleString('vi-VN') %> <%= p.currency %></td>
                    <td><%= p.sku || '-' %></td>
                    <td style="white-space:nowrap">
                      <a class="btn btn-sm btn-outline-secondary" href="/admin/product/edit/<%= p.id %>">Sửa</a>

                      <form method="post" action="/admin/product/delete" style="display:inline-block" 
                            onsubmit="return confirm('Xóa sản phẩm?');">
                        <input type="hidden" name="id" value="<%= p.id %>">
                        <button class="btn btn-sm btn-danger">Xóa</button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="text-muted">Chưa có sản phẩm.</div>
          <% } %>

        </div>
      </div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="col-md-7">




      <!-- BOOKS -->
      <div class="card mb-3">
        <div class="card-body">
          <h5>Quản lý Chủ đề</h5>
          <p><a href="/admin/book/new" class="btn btn-sm btn-success">Tạo chủ đề mới</a></p>

          <table class="table table-sm">
            <thead>
              <tr><th>Tiêu đề</th><th>Lớp</th><th>Khu vực</th><th></th></tr>
            </thead>
            <tbody>
              <% books.forEach(b => { %>
                <tr>
                  <td>
                    <% if (b.cover) { %>
                      <img src="<%= b.cover %>" style="height:36px;margin-right:8px;vertical-align:middle;">
                    <% } %>
                    <strong><%= b.title %></strong><br>
                    <small class="text-muted"><%= b.description %></small>
                  </td>
                  <td><%= b.class_name %></td>
                  <td><%= b.region_name %></td>
                  <td style="white-space:nowrap">
                    <a href="/admin/book/edit/<%= b.id %>" class="btn btn-sm btn-outline-secondary">Sửa</a>
                    <form method="post" action="/admin/book/delete" style="display:inline-block"
                          onsubmit="return confirm('Xóa chủ đề này?');">
                      <input type="hidden" name="id" value="<%= b.id %>">
                      <button class="btn btn-sm btn-danger">Xóa</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>

        </div>
      </div>


      <!-- ARTICLES -->
      <div class="card mb-3">
        <div class="card-body">
          <h5>Tất cả bài học</h5>

          <table class="table table-sm">
            <thead>
              <tr><th>Tiêu đề</th><th>Chủ đề</th><th>Ngày</th><th></th></tr>
            </thead>
            <tbody>
              <% articles.forEach(a => { %>
                <tr>
                  <td><a href="/lesson/<%= a.id %>"><%= a.title %></a></td>
                  <td><%= a.topic || '-' %></td>
                  <td><%= new Date(a.created_at).toLocaleString('vi-VN') %></td>
                  <td style="white-space:nowrap">
                    <a href="/admin/edit/<%= a.id %>" class="btn btn-sm btn-outline-secondary">Sửa</a>
                    <form method="post" action="/admin/delete-lesson" style="display:inline-block"
                          onsubmit="return confirm('Xóa bài học này?');">
                      <input type="hidden" name="id" value="<%= a.id %>">
                      <button class="btn btn-sm btn-danger">Xóa</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>

        </div>
      </div>


      <!-- SPECIAL ARTICLES -->
      <div class="card mb-5">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Danh sách bài báo</h5>
            <a class="btn btn-sm btn-success" href="/admin/special/new">Tạo bài báo mới</a>
          </div>

          <table class="table table-sm">
            <thead>
              <tr><th>Tiêu đề</th><th>Ngày</th><th>Trạng thái</th><th></th></tr>
            </thead>
            <tbody>
              <% specials.forEach(s => { %>
                <tr>
                  <td><a href="/admin/special/<%= s.id %>"><%= s.title %></a></td>
                  <td><%= new Date(s.created_at).toLocaleString('vi-VN') %></td>
                  <td><%= s.published ? "Published" : "Draft" %></td>
                  <td style="white-space:nowrap">
                    <a href="/admin/special/edit/<%= s.id %>" class="btn btn-sm btn-outline-secondary">Sửa</a>

                    <form method="post" action="/admin/special/delete"
                          style="display:inline-block"
                          onsubmit="return confirm('Xóa bài báo?');">
                      <input type="hidden" name="id" value="<%= s.id %>">
                      <button class="btn btn-sm btn-danger">Xóa</button>
                    </form>

                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>

        </div>
      </div>

    </div>
  </div>
</div>


<!-- CKEditor -->
<script src="https://cdn.ckeditor.com/ckeditor5/41.2.1/classic/ckeditor.js"></script>

<script>
  if (document.querySelector('#editorObjectives')) {
    ClassicEditor.create(document.querySelector('#editorObjectives'), {
      toolbar: ['bold','italic','underline','bulletedList','numberedList','undo','redo']
    }).catch(console.error);
  }

  if (document.querySelector('#editor')) {
    ClassicEditor.create(document.querySelector('#editor'), {
      ckfinder: { uploadUrl: '/admin/upload-image' },
      toolbar: [
        'heading','|','bold','italic','underline','link','imageUpload','|',
        'bulletedList','numberedList','insertTable','blockQuote','|','undo','redo'
      ]
    }).catch(console.error);
  }
</script>

<%- include('partials/footer') %>
