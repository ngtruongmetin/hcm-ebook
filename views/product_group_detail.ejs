<%- include('partials/header', { title: title }) %>

<style>
  .page-head { margin-bottom:18px; }
  .product-card { transition:.12s; }
  .product-card:hover { transform:translateY(-6px); box-shadow:0 10px 25px rgba(0,0,0,0.06); }
  .price { font-weight:600; }
  .contact-note { font-size:0.95rem; }
</style>

<div class="container mt-4">

  <div class="page-head d-flex justify-content-between align-items-start">
    <div>
      <h2 class="mb-1"><%= group.name %></h2>
      <% if (group.description) { %>
        <p class="text-muted"><%= group.description %></p>
      <% } %>
    </div>

    <div class="ms-3">
      <button id="buyGroupBtn" type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#contactModal">
        Mua/Liên hệ
      </button>
    </div>
  </div>

  <% if (!products || products.length === 0) { %>
    <div class="alert alert-light">Chưa có sản phẩm trong nhóm này.</div>
  <% } else { %>
    <div class="row">
      <% products.forEach(p => { %>
        <div class="col-md-3 mb-3">
          <div class="card product-card h-100">
            <% if (p.cover) { %>
              <img src="<%= p.cover %>" alt="<%= p.title %>" class="card-img-top" style="height:160px;object-fit:cover;">
            <% } else { %>
              <img src="/public/defaults/book-cover.png" alt="<%= p.title %>" class="card-img-top" style="height:160px;object-fit:cover;opacity:0.9;">
            <% } %>

            <div class="card-body d-flex flex-column">
              <h6 class="mb-1"><%= p.title %></h6>

              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="price">
                  <%= Number(p.price).toLocaleString('vi-VN') %>
                  <small class="text-muted"><%= p.currency %></small>
                </div>
                <% if (p.sku) { %>
                  <small class="text-muted">SKU: <%= p.sku %></small>
                <% } %>
              </div>

              <button type="button"
                      class="btn btn-outline-primary btn-sm mt-auto"
                      data-bs-toggle="modal"
                      data-bs-target="#contactModal">
                Mua sản phẩm
              </button>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<!-- Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="contactModalLabel">Liên hệ để mua hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>

      <div class="modal-body">
        <p class="contact-note">Website hiện chưa hỗ trợ thanh toán trực tuyến. Vui lòng liên hệ bằng các kênh:</p>

        <ul class="list-unstyled mt-3">
          <% if (contact && contact.facebook) { %>
            <li class="mb-2">
              <a class="btn btn-outline-primary w-100 text-start" href="<%= contact.facebook %>" target="_blank" rel="noopener">
                <strong>Fanpage Facebook</strong><br><small class="text-muted"><%= contact.facebook %></small>
              </a>
            </li>
          <% } %>

          <% if (contact && contact.zalo) { %>
            <li class="mb-2">
              <a class="btn btn-outline-success w-100 text-start" href="<%= contact.zalo %>" target="_blank" rel="noopener">
                <strong>Zalo</strong><br><small class="text-muted"><%= contact.zalo %></small>
              </a>
            </li>
          <% } %>

          <% if (contact && contact.phone) { %>
            <li>
              <a class="btn btn-outline-dark w-100 text-start" href="tel:<%= contact.phone.replace(/\s+/g,'') %>">
                <strong>Gọi điện thoại</strong><br><small class="text-muted"><%= contact.phone %></small>
              </a>
            </li>
          <% } %>
        </ul>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="contactModalCloseBtn">Đóng</button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
/*
  Minimal, precise JS:
  - only attach to elements that explicitly target #contactModal
  - show via bootstrap API
  - ensure close buttons call instance.hide()
*/
(function(){
  function qAll(sel){ return Array.from(document.querySelectorAll(sel || '')); }

  var modalEl = document.getElementById('contactModal');
  if (!modalEl) return;

  // selector for elements that target this modal:
  var selector = '[data-bs-target="#contactModal"], [data-target="#contactModal"], #buyGroupBtn';
  var triggers = qAll(selector);

  // safely show modal using bootstrap API or jQuery fallback
  function safeShow() {
    try {
      if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
        var inst = window.bootstrap.Modal.getOrCreateInstance(modalEl);
        inst.show();
        return;
      }
    } catch(e){}
    try {
      if (window.jQuery && typeof jQuery(modalEl).modal === 'function') {
        jQuery(modalEl).modal('show');
        return;
      }
    } catch(e){}
    alert('Vui lòng liên hệ: ' + (window.contactPhone || ''));
  }

  triggers.forEach(function(btn){
    btn.addEventListener('click', function(ev){
      // only handle clicks that actually target contactModal (avoid other behaviors)
      // let default click happen if target is not intended (defensive)
      ev.preventDefault();
      safeShow();
    });
  });

  // ensure close works — attach to close buttons inside modal (both btn-close and our footer)
  function safeHide() {
    try {
      if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
        var inst = window.bootstrap.Modal.getInstance(modalEl);
        if (!inst) inst = window.bootstrap.Modal.getOrCreateInstance(modalEl);
        inst.hide();
        return;
      }
    } catch(e){}
    try {
      if (window.jQuery && typeof jQuery(modalEl).modal === 'function') {
        jQuery(modalEl).modal('hide');
        return;
      }
    } catch(e){}
  }

  // buttons that should close modal
  var closeBtns = qAll('.btn-close, #contactModalCloseBtn, [data-bs-dismiss="modal"], [data-dismiss="modal"]');
  closeBtns.forEach(function(b){
    b.addEventListener('click', function(ev){
      ev.preventDefault();
      safeHide();
    });
  });

  // also listen for Escape key to hide (UX)
  document.addEventListener('keydown', function(ev){
    if (ev.key === 'Escape') safeHide();
  });
})();
</script>
